// ==UserScript==
// @name         Canvas | Discussions | Discussion Setting Analytics
// @version      1.0
// @description  Display a summary of all discussion settings in a Canvas course with tabbed interface
// @match        https://*.instructure.com/courses/*/discussion_topics
// @grant        none
// ==/UserScript==

(function() {
    'use strict';

    // Extract course ID from URL
    const courseId = window.location.pathname.match(/\/courses\/(\d+)/)?.[1];
    if (!courseId) return;

    let currentDiscussions = [];
    let assignmentGroups = {};
    let groupCategories = {};
    let currentTab = 'basic'; // 'basic', 'groups', or 'additional'
    let sortColumn = 'title';
    let sortDirection = 'asc';
    let sortState = {
        basic: { column: 'title', direction: 'asc' },
        groups: { column: 'title', direction: 'asc' },
        additional: { column: 'title', direction: 'asc' }
    };

    // Wait for the header bar to load
    function addButton() {
        const rightOfCrumbs = document.querySelector('.right-of-crumbs');
        if (!rightOfCrumbs) {
            setTimeout(addButton, 100);
            return;
        }

        // Create button with Canvas styling matching the quiz script
        const button = document.createElement('button');
        button.className = 'btn';
        button.innerHTML = 'âš¡Discussion Settings Analytics';
        button.title = 'View Discussion Settings Summary';
        button.setAttribute('aria-label', 'View Discussion Settings Summary');
        button.style.cssText = 'margin-right: 8px; border: 2px solid #0374B5; transition: background-color 0.2s ease;';

        // Add hover effect
        button.addEventListener('mouseenter', function() {
            this.style.setProperty('background-color', '#e8e8e8', 'important');
        });
        button.addEventListener('mouseleave', function() {
            this.style.setProperty('background-color', '', '');
        });

        // Insert at the beginning
        rightOfCrumbs.insertBefore(button, rightOfCrumbs.firstChild);

        button.onclick = fetchDiscussions;
    }

    addButton();

    // Create modal
    const modal = document.createElement('div');
    modal.style.cssText = `
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 10001;
        overflow: auto;
    `;

    const modalContent = document.createElement('div');
    modalContent.style.cssText = `
        background: white;
        margin: 40px auto;
        padding: 20px;
        width: 95%;
        max-width: 1600px;
        border-radius: 8px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.3);
    `;

    const closeBtn = document.createElement('button');
    closeBtn.textContent = 'Ã— Close';
    closeBtn.style.cssText = `
        float: right;
        background: #dc3545;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
    `;
    closeBtn.addEventListener('mouseenter', () => closeBtn.style.background = '#c82333');
    closeBtn.addEventListener('mouseleave', () => closeBtn.style.background = '#dc3545');
    closeBtn.onclick = () => modal.style.display = 'none';

    const title = document.createElement('h2');
    title.textContent = 'Discussion Settings Summary (Graded Discussions Only)';
    title.style.marginTop = '0';

    const contentArea = document.createElement('div');
    contentArea.id = 'discussion-summary-content';

    modalContent.appendChild(closeBtn);
    modalContent.appendChild(title);
    modalContent.appendChild(contentArea);
    modal.appendChild(modalContent);
    document.body.appendChild(modal);

    // Add ESC key handler to close modal
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.style.display === 'block') {
            modal.style.display = 'none';
        }
    });

    // Function to fetch assignment groups
    async function fetchAssignmentGroups() {
        try {
            const response = await fetch(`/api/v1/courses/${courseId}/assignment_groups`, {
                headers: {
                    'Accept': 'application/json'
                }
            });

            if (!response.ok) {
                return {};
            }

            const groups = await response.json();
            const groupMap = {};
            groups.forEach(group => {
                groupMap[group.id] = group.name;
            });
            return groupMap;
        } catch (error) {
            console.error('Error fetching assignment groups:', error);
            return {};
        }
    }

    // Function to fetch group categories (group sets)
    async function fetchGroupCategories() {
        try {
            const response = await fetch(`/api/v1/courses/${courseId}/group_categories`, {
                headers: {
                    'Accept': 'application/json'
                }
            });

            if (!response.ok) {
                return {};
            }

            const categories = await response.json();
            const categoryMap = {};
            categories.forEach(category => {
                categoryMap[category.id] = category.name;
            });
            return categoryMap;
        } catch (error) {
            console.error('Error fetching group categories:', error);
            return {};
        }
    }

    // Function to fetch all discussions
    async function fetchDiscussions() {
        contentArea.innerHTML = '<p>Loading discussions...</p>';
        modal.style.display = 'block';

        try {
            // Fetch assignment groups and group categories first
            assignmentGroups = await fetchAssignmentGroups();
            groupCategories = await fetchGroupCategories();

            let allDiscussions = [];
            let page = 1;
            let hasMore = true;

            while (hasMore) {
                const response = await fetch(`/api/v1/courses/${courseId}/discussion_topics?include[]=all_dates&include[]=sections&include[]=assignment&per_page=100&page=${page}`, {
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Failed to fetch discussions: ${response.status}`);
                }

                const discussions = await response.json();
                allDiscussions = allDiscussions.concat(discussions);

                // Check if there are more pages
                const linkHeader = response.headers.get('Link');
                hasMore = linkHeader && linkHeader.includes('rel="next"');
                page++;
            }

            // Filter to only graded discussions (those with assignment_id)
            currentDiscussions = allDiscussions.filter(discussion => discussion.assignment_id);

            // Set initial sort based on default tab
            currentTab = 'basic';
            sortColumn = sortState[currentTab].column;
            sortDirection = sortState[currentTab].direction;
            sortQuizzes(sortColumn);
        } catch (error) {
            contentArea.innerHTML = `<p style="color: red;">Error loading discussions: ${error.message}</p>`;
        }
    }

    // Function to switch tabs
    function switchTab(tab) {
        currentTab = tab;
        // Restore sort state for this tab
        sortColumn = sortState[tab].column;
        sortDirection = sortState[tab].direction;
        displayDiscussions();
    }

    // Function to sort discussions
    function sortQuizzes(column) {
        if (sortColumn === column) {
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            sortColumn = column;
            sortDirection = 'asc';
        }

        // Save sort state for current tab
        sortState[currentTab] = { column: sortColumn, direction: sortDirection };

        currentDiscussions.sort((a, b) => {
            let valA, valB;

            switch(column) {
                case 'title':
                    valA = a.title.toLowerCase();
                    valB = b.title.toLowerCase();
                    break;
                case 'assignment_group':
                    valA = (assignmentGroups[a.assignment?.assignment_group_id] || 'Unknown').toLowerCase();
                    valB = (assignmentGroups[b.assignment?.assignment_group_id] || 'Unknown').toLowerCase();
                    break;
                case 'published':
                    valA = a.published ? 1 : 0;
                    valB = b.published ? 1 : 0;
                    break;
                case 'points':
                    valA = a.assignment?.points_possible || 0;
                    valB = b.assignment?.points_possible || 0;
                    break;
                case 'threaded':
                    valA = a.discussion_type === 'threaded' ? 1 : 0;
                    valB = b.discussion_type === 'threaded' ? 1 : 0;
                    break;
                case 'require_initial':
                    valA = a.require_initial_post ? 1 : 0;
                    valB = b.require_initial_post ? 1 : 0;
                    break;
                case 'due_date':
                    valA = a.assignment?.due_at ? new Date(a.assignment.due_at).getTime() : 0;
                    valB = b.assignment?.due_at ? new Date(b.assignment.due_at).getTime() : 0;
                    break;
                case 'unlock_at':
                    valA = a.unlock_at ? new Date(a.unlock_at).getTime() : 0;
                    valB = b.unlock_at ? new Date(b.unlock_at).getTime() : 0;
                    break;
                case 'lock_at':
                    valA = a.lock_at ? new Date(a.lock_at).getTime() : 0;
                    valB = b.lock_at ? new Date(b.lock_at).getTime() : 0;
                    break;
                case 'peer_reviews':
                    valA = a.assignment?.peer_reviews ? 1 : 0;
                    valB = b.assignment?.peer_reviews ? 1 : 0;
                    break;
                case 'podcast':
                    valA = a.podcast_has_student_posts ? 1 : 0;
                    valB = b.podcast_has_student_posts ? 1 : 0;
                    break;
                case 'allow_rating':
                    valA = a.allow_rating ? 1 : 0;
                    valB = b.allow_rating ? 1 : 0;
                    break;
                case 'only_graders':
                    valA = a.only_graders_can_rate ? 1 : 0;
                    valB = b.only_graders_can_rate ? 1 : 0;
                    break;
                case 'attachments':
                    valA = (a.discussion_type === 'side_comment') ? 0 : 1;
                    valB = (b.discussion_type === 'side_comment') ? 0 : 1;
                    break;
                case 'group_discussion':
                    valA = a.group_category_id ? 1 : 0;
                    valB = b.group_category_id ? 1 : 0;
                    break;
                case 'group_set':
                    valA = (groupCategories[a.group_category_id] || 'N/A').toLowerCase();
                    valB = (groupCategories[b.group_category_id] || 'N/A').toLowerCase();
                    break;
                case 'grading_type':
                    valA = (a.assignment?.grading_type || 'points').toLowerCase();
                    valB = (b.assignment?.grading_type || 'points').toLowerCase();
                    break;
                case 'rubric':
                    valA = a.assignment?.use_rubric_for_grading ? 1 : 0;
                    valB = b.assignment?.use_rubric_for_grading ? 1 : 0;
                    break;
                default:
                    return 0;
            }

            if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
            if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
            return 0;
        });

        displayDiscussions();
    }

    // Function to create sortable header
    function createSortableHeader(text, column) {
        const arrow = sortColumn === column ? (sortDirection === 'asc' ? ' â–²' : ' â–¼') : '';
        return `<th style="padding: 10px; text-align: left; border: 1px solid #ddd; cursor: pointer; user-select: none;" data-column="${column}">
            ${text}${arrow}
        </th>`;
    }

    // Function to display discussions in a table
    function displayDiscussions() {
        if (currentDiscussions.length === 0) {
            contentArea.innerHTML = '<p>No graded discussions found in this course.</p>';
            return;
        }

        contentArea.innerHTML = '';

        // Add tab navigation
        const tabContainer = document.createElement('div');
        tabContainer.style.cssText = 'margin-bottom: 15px; border-bottom: 2px solid #ddd;';

        const tabs = [
            { id: 'basic', label: 'Basic & Scheduling' },
            { id: 'groups', label: 'Groups & Collaboration' },
            { id: 'additional', label: 'Additional Settings' }
        ];

        tabs.forEach(tab => {
            const tabBtn = document.createElement('button');
            tabBtn.textContent = tab.label;
            tabBtn.style.cssText = `
                padding: 10px 20px;
                border: none;
                background: ${currentTab === tab.id ? '#0374B5' : '#f5f5f5'};
                color: ${currentTab === tab.id ? 'white' : '#333'};
                cursor: pointer;
                margin-right: 5px;
                border-radius: 4px 4px 0 0;
                font-weight: ${currentTab === tab.id ? 'bold' : 'normal'};
                transition: background-color 0.2s;
            `;

            if (currentTab !== tab.id) {
                tabBtn.addEventListener('mouseenter', function() {
                    this.style.background = '#e0e0e0';
                });
                tabBtn.addEventListener('mouseleave', function() {
                    this.style.background = '#f5f5f5';
                });
            }

            tabBtn.onclick = () => switchTab(tab.id);
            tabContainer.appendChild(tabBtn);
        });

        contentArea.appendChild(tabContainer);

        // Add sorting info message
        const infoMessage = document.createElement('div');
        infoMessage.style.cssText = 'margin-bottom: 10px; font-size: 13px; color: #666; font-style: italic;';
        infoMessage.textContent = 'ðŸ’¡ Click column headers to sort. Click again to reverse sort order.';
        contentArea.appendChild(infoMessage);

        // Create table wrapper for horizontal scrolling
        const tableWrapper = document.createElement('div');
        tableWrapper.style.cssText = 'overflow-x: auto;';

        const table = document.createElement('table');
        table.style.cssText = `
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        `;

        const thead = document.createElement('thead');

        if (currentTab === 'basic') {
            thead.innerHTML = `
                <tr style="background: #f5f5f5; border-bottom: 2px solid #ddd;">
                    ${createSortableHeader('Discussion Name', 'title')}
                    ${createSortableHeader('Assignment Group', 'assignment_group')}
                    ${createSortableHeader('Published', 'published')}
                    ${createSortableHeader('Points', 'points')}
                    ${createSortableHeader('Due Date', 'due_date')}
                    ${createSortableHeader('Available From', 'unlock_at')}
                    ${createSortableHeader('Available Until', 'lock_at')}
                    ${createSortableHeader('Threaded Replies', 'threaded')}
                    ${createSortableHeader('Must Respond First', 'require_initial')}
                </tr>
            `;
        } else if (currentTab === 'groups') {
            thead.innerHTML = `
                <tr style="background: #f5f5f5; border-bottom: 2px solid #ddd;">
                    ${createSortableHeader('Discussion Name', 'title')}
                    ${createSortableHeader('Group Discussion', 'group_discussion')}
                    ${createSortableHeader('Group Set', 'group_set')}
                    ${createSortableHeader('Peer Reviews', 'peer_reviews')}
                </tr>
            `;
        } else if (currentTab === 'additional') {
            thead.innerHTML = `
                <tr style="background: #f5f5f5; border-bottom: 2px solid #ddd;">
                    ${createSortableHeader('Discussion Name', 'title')}
                    ${createSortableHeader('Podcast Feed', 'podcast')}
                    ${createSortableHeader('Allow Liking', 'allow_rating')}
                    ${createSortableHeader('Only Graders Like', 'only_graders')}
                    ${createSortableHeader('Allow Attachments', 'attachments')}
                    ${createSortableHeader('Grading Type', 'grading_type')}
                    ${createSortableHeader('Rubric', 'rubric')}
                </tr>
            `;
        }

        table.appendChild(thead);

        // Add click handlers to headers
        thead.querySelectorAll('th[data-column]').forEach(th => {
            th.onclick = () => sortQuizzes(th.dataset.column);
        });

        const tbody = document.createElement('tbody');
        currentDiscussions.forEach((discussion, index) => {
            const row = document.createElement('tr');
            row.style.cssText = `
                border-bottom: 1px solid #ddd;
                background: ${index % 2 === 0 ? 'white' : '#f9f9f9'};
            `;

            if (currentTab === 'basic') {
                // Get assignment group name
                const groupName = assignmentGroups[discussion.assignment?.assignment_group_id] || 'Unknown';
                const points = discussion.assignment?.points_possible || 0;
                const isThreaded = discussion.discussion_type === 'threaded';
                const requireInitial = discussion.require_initial_post;
                const dueDate = discussion.assignment?.due_at ? new Date(discussion.assignment.due_at).toLocaleString() : 'N/A';
                const unlockAt = discussion.unlock_at ? new Date(discussion.unlock_at).toLocaleString() : 'N/A';
                const lockAt = discussion.lock_at ? new Date(discussion.lock_at).toLocaleString() : 'N/A';

                row.innerHTML = `
                    <td style="padding: 10px; border: 1px solid #ddd;">
                        <a href="/courses/${courseId}/discussion_topics/${discussion.id}/edit" target="_blank" style="color: #0374B5; text-decoration: none;">
                            ${discussion.title}
                        </a>
                    </td>
                    <td style="padding: 10px; border: 1px solid #ddd;">${groupName}</td>
                    <td style="padding: 10px; border: 1px solid #ddd; background: ${discussion.published ? '#d4edda' : '#f8d7da'};">
                        <span style="color: ${discussion.published ? '#155724' : '#721c24'}; font-weight: bold;">
                            ${discussion.published ? 'âœ“' : 'âœ—'}
                        </span>
                    </td>
                    <td style="padding: 10px; border: 1px solid #ddd;">${points}</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">${dueDate}</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">${unlockAt}</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">${lockAt}</td>
                    <td style="padding: 10px; border: 1px solid #ddd; background: ${isThreaded ? '#d4edda' : '#f8d7da'};">
                        <span style="color: ${isThreaded ? '#155724' : '#721c24'}; font-weight: bold;">
                            ${isThreaded ? 'âœ“' : 'âœ—'}
                        </span>
                    </td>
                    <td style="padding: 10px; border: 1px solid #ddd; background: ${requireInitial ? '#d4edda' : '#f8d7da'};">
                        <span style="color: ${requireInitial ? '#155724' : '#721c24'}; font-weight: bold;">
                            ${requireInitial ? 'âœ“' : 'âœ—'}
                        </span>
                    </td>
                `;
            } else if (currentTab === 'groups') {
                const isGroupDiscussion = discussion.group_category_id ? true : false;
                const groupSet = discussion.group_category_id ? (groupCategories[discussion.group_category_id] || 'Unknown') : 'N/A';
                const peerReviews = discussion.assignment?.peer_reviews || false;

                row.innerHTML = `
                    <td style="padding: 10px; border: 1px solid #ddd;">
                        <a href="/courses/${courseId}/discussion_topics/${discussion.id}/edit" target="_blank" style="color: #0374B5; text-decoration: none;">
                            ${discussion.title}
                        </a>
                    </td>
                    <td style="padding: 10px; border: 1px solid #ddd; background: ${isGroupDiscussion ? '#d4edda' : '#f8d7da'};">
                        <span style="color: ${isGroupDiscussion ? '#155724' : '#721c24'}; font-weight: bold;">
                            ${isGroupDiscussion ? 'âœ“' : 'âœ—'}
                        </span>
                    </td>
                    <td style="padding: 10px; border: 1px solid #ddd;">${groupSet}</td>
                    <td style="padding: 10px; border: 1px solid #ddd; background: ${peerReviews ? '#d4edda' : '#f8d7da'};">
                        <span style="color: ${peerReviews ? '#155724' : '#721c24'}; font-weight: bold;">
                            ${peerReviews ? 'âœ“' : 'âœ—'}
                        </span>
                    </td>
                `;
            } else if (currentTab === 'additional') {
                const podcast = discussion.podcast_has_student_posts || false;
                const allowRating = discussion.allow_rating || false;
                const onlyGraders = discussion.only_graders_can_rate || false;
                // Focused discussions (side_comment) don't allow attachments
                const allowAttachments = discussion.discussion_type !== 'side_comment';

                // Grading type
                const gradingType = discussion.assignment?.grading_type || 'points';
                const gradingTypeDisplay = gradingType.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());

                // Rubric
                const assignment = discussion.assignment;
                const hasRubric = assignment?.rubric_settings?.id || assignment?.rubric?.length > 0 || false;
                let rubricDisplay = '<span style="color: #721c24; font-weight: bold;">âœ—</span>';
                let rubricBg = '#f8d7da';

                if (hasRubric) {
                    // Try to get rubric ID from rubric_settings or rubric array
                    const rubricId = assignment?.rubric_settings?.id || assignment?.rubric?.[0]?.id;
                    const rubricTitle = assignment?.rubric_settings?.title || assignment?.rubric?.[0]?.title;

                    if (rubricId) {
                        rubricDisplay = `<a href="/courses/${courseId}/rubrics/${rubricId}" target="_blank" style="color: #0374B5; text-decoration: none;">${rubricTitle || 'View Rubric'}</a>`;
                        rubricBg = 'white'; // No background color for better link readability
                    } else {
                        rubricDisplay = '<span style="color: #155724; font-weight: bold;">âœ“</span>';
                        rubricBg = '#d4edda';
                    }
                }

                row.innerHTML = `
                    <td style="padding: 10px; border: 1px solid #ddd;">
                        <a href="/courses/${courseId}/discussion_topics/${discussion.id}/edit" target="_blank" style="color: #0374B5; text-decoration: none;">
                            ${discussion.title}
                        </a>
                    </td>
                    <td style="padding: 10px; border: 1px solid #ddd; background: ${podcast ? '#d4edda' : '#f8d7da'};">
                        <span style="color: ${podcast ? '#155724' : '#721c24'}; font-weight: bold;">
                            ${podcast ? 'âœ“' : 'âœ—'}
                        </span>
                    </td>
                    <td style="padding: 10px; border: 1px solid #ddd; background: ${allowRating ? '#d4edda' : '#f8d7da'};">
                        <span style="color: ${allowRating ? '#155724' : '#721c24'}; font-weight: bold;">
                            ${allowRating ? 'âœ“' : 'âœ—'}
                        </span>
                    </td>
                    <td style="padding: 10px; border: 1px solid #ddd; background: ${onlyGraders ? '#d4edda' : '#f8d7da'};">
                        <span style="color: ${onlyGraders ? '#155724' : '#721c24'}; font-weight: bold;">
                            ${onlyGraders ? 'âœ“' : 'âœ—'}
                        </span>
                    </td>
                    <td style="padding: 10px; border: 1px solid #ddd; background: ${allowAttachments ? '#d4edda' : '#f8d7da'};">
                        <span style="color: ${allowAttachments ? '#155724' : '#721c24'}; font-weight: bold;">
                            ${allowAttachments ? 'âœ“' : 'âœ—'}
                        </span>
                    </td>
                    <td style="padding: 10px; border: 1px solid #ddd;">${gradingTypeDisplay}</td>
                    <td style="padding: 10px; border: 1px solid #ddd; background: ${rubricBg};">
                        ${rubricDisplay}
                    </td>
                `;
            }

            tbody.appendChild(row);
        });

        table.appendChild(tbody);
        tableWrapper.appendChild(table);
        contentArea.appendChild(tableWrapper);

        // Add summary stats
        const stats = document.createElement('div');
        stats.style.cssText = 'margin-top: 20px; padding: 10px; background: #f5f5f5; border-radius: 4px;';
        stats.innerHTML = `<strong>Total Graded Discussions:</strong> ${currentDiscussions.length} | <strong>Published:</strong> ${currentDiscussions.filter(d => d.published).length} | <strong>Unpublished:</strong> ${currentDiscussions.filter(d => !d.published).length}`;
        contentArea.appendChild(stats);
    }
})();
