// ==UserScript==
// @name         Canvas | Show Course ID Everywhere
// @namespace    https://greasyfork.org/en/users/670188-hacker09?sort=daily_installs
// @version      5
// @description  Shows the full course name and course code of your class on any page.
// @author       hacker09
// @match        https://*.instructure.com/*
// @run-at       document-idle
// @grant        none
// ==/UserScript==

(function() {
  'use strict';

  // Cache to avoid repeated fetches
  const courseCache = new Map();
  let isProcessing = false;

  async function getCourseDetails(courseId) {
    if (courseCache.has(courseId)) {
      return courseCache.get(courseId);
    }

    try {
      const response = await fetch(`${location.origin}/courses/${courseId}`);
      if (!response.ok) {
        console.error('Failed to fetch course details.');
        return null;
      }

      const html = await response.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const title = doc.title;

      courseCache.set(courseId, title);
      return title;
    } catch (error) {
      console.error('Error fetching course data:', error);
      return null;
    }
  }

  async function updateCourseTitle() {
    // Prevent concurrent executions
    if (isProcessing) return;
    isProcessing = true;

    try {
      const ellipsibleElements = document.querySelectorAll('span.ellipsible');

      // Check if we have the target element and if we're not on the home page
      if (ellipsibleElements.length > 1 && location.pathname.split('/').length > 3) {
        const courseId = location.pathname.split('/')[2];
        const courseTitleElement = ellipsibleElements[1];

        // Skip if already modified
        if (courseTitleElement.id === 'CourseModified') {
          return;
        }

        const fullCourseTitle = await getCourseDetails(courseId);

        if (fullCourseTitle && courseTitleElement) {
          const originalText = courseTitleElement.innerText;
          courseTitleElement.innerText = `${fullCourseTitle} â€” ${originalText}`;
          courseTitleElement.title = courseTitleElement.innerText;
          courseTitleElement.id = 'CourseModified';

          // Add styles if not already present
          if (!document.getElementById('course-id-style')) {
            const style = document.createElement('style');
            style.id = 'course-id-style';
            style.textContent = '#CourseModified {max-width: 100%; word-wrap: break-word;}';
            document.head.appendChild(style);
          }
        }
      }
    } catch (error) {
      console.error('Error processing the course data:', error);
    } finally {
      isProcessing = false;
    }
  }

  // Initial run
  updateCourseTitle();

  // Watch for DOM changes (Canvas is a SPA)
  const observer = new MutationObserver((mutations) => {
    // Debounce to avoid excessive runs
    clearTimeout(observer.timer);
    observer.timer = setTimeout(updateCourseTitle, 300);
  });

  observer.observe(document.body, {
    childList: true,
    subtree: true
  });

  // Also run on URL changes (for SPA navigation)
  let lastUrl = location.href;
  new MutationObserver(() => {
    const url = location.href;
    if (url !== lastUrl) {
      lastUrl = url;
      setTimeout(updateCourseTitle, 500);
    }
  }).observe(document.querySelector('title'), {
    childList: true,
    subtree: true
  });

})();
